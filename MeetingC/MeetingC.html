{{ block title }}Virtual Video Call{{ endblock }}

{{ block content }}
    <!-- load library for RadarChart-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- load library for jitsi Meeting-->
    <script src="https://meet.jit.si/external_api.js"></script>

    <!-- split the screen into five boxes by using two rows. The first row with two columns and a second row with three-->
    <!-- TODO: rename/refactor upper_column etc. for more clarity-->
    <style>
        /*I don't know exactly what's this about.. but leave it there for now*/
        * {
            box-sizing: border-box;
        }

        /* first row with two columns 60-40 */
        .upper_row {
            width: 1200px;
        }
        .upper_column {
            float: left;
            height: 479px;
        }
        .upper_left {
            width: 70%;
        }
        .upper_right {
            width: 30%;
            display: flex;
            align-items: center;
        }
        .upper_row:after {
            content: "";
            display: table;
            clear: both;
        }  /* clear after upper row */

        /* second row with three columns 45-15-40 */
        .lower_row {
            width: 1200px;
        }
        .lower_column {
            float: left;
            height: 330px;
        }
        .lower_left {
            width: 45%;
            overflow: auto;
            padding: 10px;
        }
        .lower_center {
            width: 15%;
            padding: 10px;
            text-align: center;
        }
        .lower_right {
            width: 40%;
            vertical-align: middle;
            padding: 10px;
        }
        .lower_row:after {
            content: "";
            display: table;
            clear: both;
        }  /* clear after lower row */

        /* table for project ranking (team) */
        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black;
        }
        td {
            width: calc(100% / 8);
            border: 1px solid black;
            text-align: center;
        }

        #display_lock_button {
            background-color: orange;
        }

        #agree_button {
            background-color: green;
        }

    </style>

    <!-- show the container and related content of the first row (upper_row) on the page -->
    <div class="upper_row">
        <!--left box for the jitsy video meeting-->
        <div class="upper_column upper_left" style="background-color: lightgreen;">
            <!-- <div id=meet></div>  --> Videomeeting, is working :)
        </div>
        <!--right box for the spider graph-->
        <!-- do i need the id tag below? -->
        <div id="radarChartContainer" class="upper_column upper_right" style="border: 2px solid green">
            <canvas id ="myRadarChart"></canvas>
        </div>
    </div>

    <!-- show the container and related content of the second row (lower_row) on the page-->
    <div class="lower_row">
         <!--left box for individual Project information-->
        <div class="lower_column lower_left" style="background-color: lightyellow;">
            <h2>Recap: Individual Project Information</h2>
            <br><u><b>Project A: Virtual Reality Fitness Adventure Game</b></u><br>
            {{session.desc_pro_A}}<br><br>
            {{unique_a}}<br>
            {{shared_a}}<br>

            <br><u><b>Project B: AI-Powered Personalized Shopping Assistant</b></u><br>
            {{session.desc_pro_B}}<br><br>
            {{unique_b}}<br>
            {{shared_b}}<br>

            <br><u><b>Project C: Smart Home Energy Management System</b></u><br>
            {{session.desc_pro_C}}<br><br>
            {{unique_c}}<br>
            {{shared_c}}<br>
        </div>
         <!--center box for the final choice-->
        <div id="final_choice"  class="lower_column lower_center" style="background-color: yellow; display: block">
            <h2>Team Choice</h2> <br>
            <input type="checkbox" id="choice_A" onclick="handleCheckbox(this)"> <b> Project A</b><br><br>

            <input type="checkbox" id="choice_B" onclick="handleCheckbox(this)"> <b> Project B</b><br><br>

            <input type="checkbox" id="choice_C" onclick="handleCheckbox(this)"> <b> Project C</b><br><br>

            <button id="agree_button" type="button" class="btn btn-primary" onclick="sendAgreement()" style="display: inline-block; float: left">I agree</button>
            <button id="display_lock_button" type="button" class="btn btn-primary" onclick="lock_in()" style="display: none; float: right" >lock in</button>
        </div>
        <div id="final_choice_done"  class="lower_column lower_center" style="background-color: red; display: none">
            <br><br><p>The final Choice was made and other players left the page. You are not allowed to make further changes</p>
        </div>
         <!--right box for the Project-Matrix-->
        <div class="lower_column lower_right" style="background-color: orange;">
            <h2>Team Rating</h2>

            TODO: UPDATE
            If there is agreement based on the choices of alle participants the table below shows for each project information which project fits best. TODO: MAKE IT STATIC

            <!--Table containing the project-matrix-->
            <table border="1">
                <tr>
                    <td> </td>
                    <td> Project A</td>
                    <td> Project B</td>
                    <td> Project C</td>
                </tr>
                <tr>
                    <td> {{Information1}} </td>
                    <td> {{A1}} </td>
                    <td> {{B1}} </td>
                    <td> {{C1}} </td>
                </tr>
                 <tr>
                    <td> {{Information2}} </td>
                    <td> {{A2}} </td>
                    <td> {{B2}} </td>
                    <td> {{C2}} </td>
                </tr>
                <tr>
                    <td> {{Information3}} </td>
                    <td> {{A3}} </td>
                    <td> {{B3}} </td>
                    <td> {{C3}} </td>
                </tr>
                <tr>
                    <td> {{Information4}} </td>
                    <td> {{A4}} </td>
                    <td> {{B4}} </td>
                    <td> {{C4}} </td>
                </tr>
                <tr>
                    <td> {{Information5}} </td>
                    <td> {{A5}} </td>
                    <td> {{B5}} </td>
                    <td> {{C5}} </td>
                </tr>
                <tr>
                    <td> {{Information6}} </td>
                    <td> {{A6}} </td>
                    <td> {{B6}} </td>
                    <td> {{C6}} </td>
                </tr>

            </table>
        </div>
    </div>

    <br>

    <!-- Show the next button only when there is agreement -->
    <div id="display_next_button" style="display: none"> {{ next_button }} </div>
    <!-- <button id="display_next_button"  class="otree-btn-next btn btn-primary" onclick="next_adjusted()" style="display: none" >Next test</button> -->

    <!-- Script for Team Choice -->
    <script>
        // function to handle the checkboxes
        function handleCheckbox(clickedCheckbox) {
            const checkboxes = ["choice_A", "choice_B", "choice_C"];
            // make sure, that there is just one checkbox selected
            checkboxes.forEach(id => {
                if (id !== clickedCheckbox.id) {
                    document.getElementById(id).checked = false;
                }
            });
            // send checkbox information zu otree
            if (clickedCheckbox.id === "choice_A") {
                liveSend({'information': 'choice_A_selected'});
            } else if (clickedCheckbox.id === "choice_B") {
                liveSend({'information': 'choice_B_selected'});
            } else if (clickedCheckbox.id === "choice_C") {
                liveSend({'information': 'choice_C_selected'});
            }
        }

        // function to update the checkboxes for the other players, called in liveRecv
        function liveUpdateCheckbox(new_setup) {
            const [choiceA, choiceB, choiceC] = new_setup;
            document.getElementById("choice_A").checked = choiceA;
            document.getElementById("choice_B").checked = choiceB;
            document.getElementById("choice_C").checked = choiceC;
        }

        // Agreement button: send information to oTree if player1 agrees
        {% if player.id_in_group == 1 %}
            function sendAgreement() {
                liveSend({'information': 'p1_agreed'});
            }
       // Agreement button: send information to oTree if player2 agrees
        {% elif player.id_in_group == 2 %}
            function sendAgreement() {
                liveSend({'information': 'p2_agreed'});
            }
         // TODO: add player 3 and 4
        {% endif%}

        // hiding the choice field if one of the players click on next
        function lock_in() {
            liveSend({'information': 'locked'});
        }

        // function receives Information from oTrees Python part
        function liveRecv(data) {
            // Make sure that the lock in button is just displayed, if there is agreement
            if (data.finished) {
                document.getElementById("display_lock_button").style.display = "inline-block";
                document.getElementById("agree_button").style.display = "none";
            }
            if (data.finished == false) {
                document.getElementById("display_lock_button").style.display = "none";
                document.getElementById("agree_button").style.display = "inline-block";
            }

            // update checkboxes
            if  (data.checkbox_update == "choice_A_selected") {
                liveUpdateCheckbox([true, false, false]);
            }
            if  (data.checkbox_update == "choice_B_selected") {
                liveUpdateCheckbox([false, true, false]);
            }
            if  (data.checkbox_update == "choice_C_selected") {
                liveUpdateCheckbox([false, false, true]);
            }

            // hide checkboxes and show next button for all players if locked button is clicked by any player
            if (data.locked == true) {
                document.getElementById("final_choice_done").style.display = "block";
                document.getElementById("final_choice").style.display = "none";
                document.getElementById("display_next_button").style.display = "block";
            }
        }
        // when page loaded send nothing.. but could be used if some indiviudal reloads the page to set something
        //document.addEventListener('DOMContentLoaded', (event) => {
        //
        //    liveSend({});
        //});

    </script>

    <!-- Script for Radar Chart -->
    <script>
        // function for the radar chart
        function createRadarChart(total) {
            let ctx = document.getElementById('myRadarChart').getContext('2d');
            let myRadarChart = new Chart(ctx, {
                type: 'radar',
             data: {
                    labels: {{session.chosen_goals}},
                    datasets: [{
                        label: 'Player2',
                        data: js_vars.one
                               ,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Player1',
                        data: js_vars.two,
                        backgroundColor: 'rgba(5, 192, 5, 0.2)',
                        borderColor: 'rgba(5, 192, 5, 1)',
                        borderWidth: 2
                    } // TODO: add here datasets for player three and four
                    ]
                },

                options: {
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 5
                        }
                    }
                }
            });
        }

        // initialize RadaChart aka Spidergraph
        createRadarChart(5);
    </script>

    <!--Script for Jitsi Meeting -->
    <!-- Version from 2024-04-03 Anuja's Weakest Link Game -->
    <script>
        const domain = "meet.jit.si"; //Here goes your domain where the meeting takes place.
        var isStreamOn = false; //This is a variable I've defined to use later.
        const options = {
            roomName: "Weakest Link Game", //This is the name of the room.
            width: 840,                //Well, you know.
            height: 480,                //Same as above, just vertical.
            parentNode: document.querySelector('#meet'), //Now, you declare here which element should parent your stream.
            configOverwrite: {}, //You can turn on or off config elements with this prop.
            interfaceConfigOverwrite: { TOOLBAR_BUTTONS: [] },  //You can turn on or off interface elements with this prop. check https://jitsi.github.io/handbook/docs/dev-guide/dev-guide-iframe for details
            jwt: 'yourtokenhere' //Here, you should pass a JWT token for authorization purposes. If you're using jitsi-token-moderation or simiar, make sure the token you pass can start streams
        }
        const api = new JitsiMeetExternalAPI(domain, options); //This is where the iframe is actually constructed
        //The function below turns on the Tile View everytime a participant joins. Practically it makes Tile View the default mode
        api.addEventListener(`videoConferenceJoined`, () => {
            const listener = ({ enabled }) => {
                api.removeEventListener(`tileViewChanged`, listener);

                if (!enabled) {
                    api.executeCommand(`toggleTileView`);
                }
            };
        });



        function streamHandler() {
            try {
                if (!isStreamOn) {
                    document.getElementById("streamingResponseMsg").innerHTML = "Starting streaming...";
                    //The function below starts the stream or recording, according to its "mode"
                    api.executeCommand('startRecording', {
                        mode: 'stream', //recording mode, either `file` or `stream`.
                        rtmpStreamKey: '', //This where you *should* put your favoured rtmp stream server along with your key, like "rtmp:\/\/some.address/norecord/stream-key"
                        youtubeStreamKey: 'rtmp:\/\/some.address/norecord/stream-key', //the youtube stream key.
                    });
                } else {
                    document.getElementById("streamingResponseMsg").innerHTML = "Stopping streaming...";
                    //The function below stops the stream or recording, according to the string you pass. Official guide shows an object, while it should be a string
                    api.executeCommand('stopRecording', 'stream');
                }

            }
            catch (e){
                if (isStreamOn){
                    document.getElementById("streamingResponseMsg").innerHTML = "Error while stopping stream.";
                    console.log("Exception while stopping stream.", e);
                }else{
                    document.getElementById("streamingResponseMsg").innerHTML = "Error while starting stream.";
                    console.log("Exception while starting stream.", e);

                }
                this.isStreamOn = false;
             }
        };
            //This part doesn't work without making some changes to the code as per this; https://github.com/team-ai-repo/jitsi-meet/pull/4/files
            api.addEventListener("recordingStarted", () => {
                document.getElementById("stream-btn").innerHTML="Stop Streaming";
                document.getElementById("streamingResponseMsg").innerHTML = "Stream is on";
                this.isStreamOn = true;
                console.log("Example Stream On", this.isStreamOn);
            });

            api.addEventListener("recordingStopped", () => {
            document.getElementById("stream-btn").innerHTML="Start Streaming";
            document.getElementById("streamingResponseMsg").innerHTML = "Stream is off";
            console.log("Example Stream Off", this.isStreamOn);
            this.isStreamOn = false;
        });


    </script>

{{ endblock }}
